<?php

error_reporting(E_ALL^E_STRICT^E_DEPRECATED);
ini_set("display_errors", 1);


// no version global means this version
// of php is super old
if (!defined('PHP_VERSION')) {
    exit("Your version of PHP is super old. Like really, really, really, really old.\n");
}

// make sure our version is good
if (version_compare(PHP_VERSION, 5.3) === -1) {
    exit("Your version of PHP (".PHP_VERSION.") is not compatable with bolt.php\n");
}

// some opts we want
$opts = getopt("bs", array("nodep", "include::", "www::", "bin::", "pear::", "etc::"));

// include folder
if (isset($opts['include'])) {
    set_include_path(get_include_path().PATH_SEPARATOR.$opts['include']);
}

// try to include Archive/Tar.php
if ((include "Archive/Tar.php") === false) {
    exit("You don't seem to have Archive_Tar available in your include_dir. Try installing with `pear install Archive_Tar`\n");
}

// default variables
$pear = (file_exists("/usr/share/pear") ? "/usr/share/pear" : "/usr/share/php");
$bin = "/usr/local/bin";
$www = "/var/www";
$etc = "/etc";

// try to include pear
@include("PEAR/Config.php");

// if we have pear
if (class_exists('PEAR_Config')) {
    $c = new PEAR_Config();
    $pear = $c->get('php_dir');
    $bin = $c->get('bin_dir');
    $www = $c->get('www_dir');
    $etc = $c->get('cfg_dir');
    define("HAS_PEAR", true);
}
else {
    define("HAS_PEAR", false);  // no pear
}

// override from opts
foreach (array('www','bin','pear','etc') as $opt) {
    if (isset($opts[$opt])) {
        ${$opt} = $opts[$opt];
    }
}

// version
$VERSION = (isset($opts['v']) ? $opts['v'] : 'stable');

// if we heave pear
if (!HAS_PEAR) {
    exit("PEAR is required to install");
}



// // discover our channel
// echo `$pear channel-discover pear.bolthq.com\n`;

// // install this version
// echo `$pear install bolt/bolt-$VERSION\n`;

// if they want a symlink
if (isset($opts['s'])) {

    // do it
    $bolt = realpath("../src/bolt.php");
    $target = $pear."/bolt.phar";

    if (file_exists($target)) {
        unlink($target);
    }

//    var_dump($bolt, $target); die;

    // phar
    symlink($bolt,$target);

    // make sure
    $dest = "{$www}/bolt/index.php";

    // dir
    if (!file_exists(dirname($dest))) {
        mkdir(dirname($dest));
    }

    // do it
    file_put_contents($dest, stub(file_get_contents("./stub/share.inc"), "bolt.phar", ""));

    $dest = "{$bin}/bolt";

    // bin
    file_put_contents($dest, stub(file_get_contents("./stub/bin.inc"), "bolt.phar", ""));

    // done
    exit("bolt has been symliked to '{$bolt}'. Enjoy\n");
}

// done
exit("bolt has been installed. Enjoy!\n");


/// stub
function stub($str, $phar, $etc) {
    return str_replace(array('%PHAR%','%ETC'), array($phar, $etc), $str);
}