<?php

$opts = getopt("sl", array("include::", "share::", "bin::"));

// include folder
if (isset($opts['include'])) {
    set_include_path(get_include_path().PATH_SEPARATOR.$opts['include']);
}

// dest
$pear = (isset($opts['pear']) ? rtrim($opts['pear'], '/') : "/usr/share/pear");
$bin = (isset($opts['bin']) ? rtrim($opts['bin'], '/') : "/usr/local/bin/");
$share = (isset($opts['share']) ? rtrim($opts['share'], '/') : "/usr/share/php/");

// no version global means this version
// of php is super old
if (!defined('PHP_VERSION')) {
    exit("Your version of PHP is super old. Like really, really, really, really old.\n");
}

// make sure our version is good
if (version_compare(PHP_VERSION, 5.3) === -1) {
    exit("Your version of PHP (".PHP_VERSION.") is not compatable with bolt.php\n");
}

// try to include Archive/Tar.php
if ((include "Archive/Tar.php") === false) {
    exit("You don't seem to have Archive_Tar available in your include_dir. Try installing with `pear install Archive_Tar`\n");
}

// local
if (isset($opts['l'])) {
    $resp = file_get_contents("bolt-latest.tar.gz");
}

// symlink
else if (isset($opts['s'])) {

    // no a location
    if (!file_exists($pear)) {
        exit("Symlink destination '$dest' doesn't exist.\n");
    }

    // loop through source and slinkink everything
    $dir = new RecursiveDirectoryIterator('../src/');
    $it = new RecursiveIteratorIterator($dir);
    $regex = new RegexIterator($it, '/^.+\.php$/i', RecursiveRegexIterator::GET_MATCH);

    // add our files
    foreach ($regex as $file) {

        // get the path
        $path = $pear . str_replace("../src", "", $file[0]);

        // if the file already exists
        // unlink it
        if (file_exists($path)) {
            unlink($path);
        }

        // make sure the base dir exists
        if (!file_exists(dirname($path))) {
            mkdir(dirname($path), 0777, true);
        }

        // symlink the file
        link(realpath($file[0]), $path);

    }

    // bin
    $bin .= "bolt";

    // now symlink the bin file
    if (file_exists($bin)) {
        unlink($bin);
    }
    file_put_contents($bin, stub("./stub/bin.inc", "$pear/bolt.php")); chmod($bin, 0755);


    // share
    $share .= "bolt.php";

    // now symlink the share file
    if (file_exists($share)) {
        unlink($share);
    }
    file_put_contents($share, stub("./stub/share.inc", "$pear/bolt.php"));

    // done
    exit("Bolt symlink installed!\n");

}

// get from remote
else {

    // pull down the latest version
    $latest = "https://github.com/traviskuhl/bolt/raw/master/build/bolt-latest.tar.gz";

    // get it
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $latest);
    curl_setopt($ch, CURLOPT_HEADER, 0);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
    $resp = curl_exec($ch);
    curl_close($ch);

}

// nope
if (!$resp) {
    exit("Unable to retrieve the source tar at '$latest'.\n");
}

// write tar to tmp
$tmp = tempnam(sys_get_temp_dir(), 'bolt');
file_put_contents($tmp, $resp);

// open it
$tar = new Archive_Tar($tmp, 'gz');

// get the phar
$phar = $tar->extractInString('bolt.phar');

// no lib dir
if (!file_exists("/usr/local/lib/bolt")) {
    mkdir("/usr/local/lib/bolt", 0755);
}

// where the lib is going to go
$lib = "/usr/local/lib/bolt/bolt.phar";
$bin = "/usr/local/bin/bolt";
$share = "/usr/share/pear/bolt.php";

// make our stub
$stub = stub($lib);

// share already exists
if (file_exists($lib)) {
    @unlink($lib);
    @unlink($bin);
    @unlink($share);
}

// now place it. swallow the error
// and then check
@file_put_contents($lib, $phar);

    // nope
    if (!file_exists($lib)) {
        exit("Looks like you don't have permission to write to '$bin' or '$share'.\n");
    }

// no place bin
@file_put_contents($bin, $stub); chmod($bin, 0755);

// symlink to share
symlink($lib, $share);

// tell them we're done
exit("bolt has been installed. Enjoy!\n");


/// stub
function stub($file, $phar) {
    $str = file_get_contents($file);
    return str_replace('%PHAR%', $phar, $str);
}