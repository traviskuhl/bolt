#!/usr/bin/php
<?php

$opts = getopt("tn", array("nostore", "pear"));

set_include_path(get_include_path().":/Applications/MAMP/bin/php/php5.3.6/lib/php/");
date_default_timezone_set("UTC");

// tar
require "Archive/Tar.php";
require 'AWSSDKforPHP/aws.phar';

use Aws\S3\S3Client;
use Aws\Common\Enum\Region;

$cwd = getcwd(); $cfg = array();

// user
$u = (isset($_SERVER['SUDO_HOME']) ? $_SERVER['SUDO_HOME'] : $_SERVER['HOME']);
$cfgFile = "$u/.boltbuild";

// if there's a config file
if (file_exists($cfgFile)) {
    $cfg = json_decode(file_get_contents($cfgFile), true);
    if (!is_array($cfg)) {
        exit("Unable to load cfg from {$cfgFile}\n");
    }
}

$ver = get_version();

// phar
$phar = new Phar('bolt.phar', 0, 'bolt.phar');

// phar
$phar->setSignatureAlgorithm(Phar::SHA1);

// buffering
$phar->startBuffering();

// tet
if (isset($opts['t'])) {
    $sha = $version = 'test';
    $date = date("r");
    $ts = time();
}
else {
    list($sha, $date, $ts) = explode("|", trim(`git log --pretty="%h|%ci|%ct" -n1 `));
    $version = $sha;
}

// lets get our files
$dir = new RecursiveDirectoryIterator('../src/');
$it = new RecursiveIteratorIterator($dir);
$regex = new RegexIterator($it, '/^.+\.php$/i', RecursiveRegexIterator::GET_MATCH);

// add our files
foreach (iterator_to_array($regex) as $file) {

    // path - ../lib
    $path = str_replace("../src/", "", $file[0]);

    // drop some white space
    $content = stripWhitespace(file_get_contents($file[0]));

    // version
    $content = preg_replace("/const BUILD = '.*?';/", "const BUILD = '".$version."';", $content);

    // add it
    $phar->addFromString($path, $content);

}

// variables
$vars = array('sha' => $sha, 'date' => $date, 'cdate' => date('r', $ts));

// stub
$phar->setStub(stub('stub/pear.inc', $vars));

// DONE
$phar->stopBuffering();

// no phar
unset($phar);

// bin & share
$bin = stub('stub/bin.inc', $vars);
$share = stub('stub/share.inc', $vars);

// build a pear package
if (isset($opts['pear'])) {

    // create a tmp director for pear
    $tmp = "/tmp/".time(); mkdir($tmp);

    // create some files
    rename("./bolt.phar", "{$tmp}/bolt.phar");
    file_put_contents("{$tmp}/bolt", $bin);

    $data = array(
            'date' => date("Y-m-d"),
            'time' => date("H:i:s"),
            'version' => $ver,
            'build' => $ver,
            'depend' => file_get_contents("./depend.json"),
            'branch' => 'stable'
        );

    // post install
    file_put_contents("{$tmp}/BoltInstall", stub('stub/pear-install.inc', $data));

    // package
    file_put_contents("{$tmp}/package.xml", stub('stub/package.xml',$data));

    // tar
    chdir($tmp);

    // package
    echo `pear package`;

    //tar
    $glob = glob("*.tgz");
    $tar = array_shift($glob);

    // move tar to www
    `mv $tar /var/www/bolt/pear`;

    chdir("/var/www/bolt/pear");

    // add to pirum
    echo `sudo pirum add . $tar`;

    // go back
    chdir($cwd);

    `sudo rm -r $tmp`;

    exit("DONE! added $tar\n\n");

}

// chmod
chmod("bolt.phar", 0755);

if (isset($opts['n'])) {
    rename("./bolt.phar", "../tests/bolt.phar");
    echo "Phar created and placed in test\n";
    exit;
}

// create a
$tar = new Archive_Tar("./bolt-latest.tar.gz", 'gz');

// create
$tar->create(array("./bolt.phar"));

$tar->addString("bin.inc", $bin);
$tar->addString("share.inc", $share);

// add depend json
$tar->addString("depend.json", file_get_contents("depend.json"));

// archive
if (!isset($opts['nostore'])) {

    // Instantiate the S3 client with your AWS credentials and desired AWS region
    $s3 = S3Client::factory(array(
        'key'    => $cfg['s3']['key'],
        'secret' => $cfg['s3']['secret'],
    ));

    $s3->putObject(array(
            "Bucket" => $cfg['s3']['bucket'],
            "Key" => $cfg['store']['phar']."/bolt-$version.phar",
            "Body" => file_get_contents("bolt.phar")
        ));

    $s3->putObject(array(
            "Bucket" => $cfg['s3']['bucket'],
            "Key" => $cfg['store']['pkg']."/bolt-$version.tar.gz",
            "Body" => file_get_contents("bolt-latest.tar.gz")
        ));

}

// keep our phar
rename("bolt.phar", "./latest/bolt.phar");
rename("bolt-latest.tar.gz", "./latest/bolt-latest.tar.gz");

// goodbye sucka
exit("DONE!\n\n");

function get_version() {
    include("../src/bolt.php");
    return b::VERSION;
}


function stub($file, $vars=array()) {

    // get our str
    $str = file_get_contents($file);

    // parse any variables
    foreach ($vars as $name => $value) {
        $str = str_replace("%".strtoupper($name)."%", $value, $str);
    }

    // give back
    return $str;

}


/*
 * This file is part of the Silex framework.
 *
 * (c) Fabien Potencier <fabien@symfony.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
 function stripWhitespace($source){
        if (!function_exists('token_get_all')) {
            return $source;
        }

        $output = '';
        foreach (token_get_all($source) as $token) {
            if (is_string($token)) {
                $output .= $token;
            } elseif (in_array($token[0], array(T_COMMENT, T_DOC_COMMENT))) {
                $output .= str_repeat("\n", substr_count($token[1], "\n"));
            } elseif (T_WHITESPACE === $token[0]) {
                // reduce wide spaces
                $whitespace = preg_replace('{[ \t]+}', ' ', $token[1]);
                // normalize newlines to \n
                $whitespace = preg_replace('{(?:\r\n|\r|\n)}', "\n", $whitespace);
                // trim leading spaces
                $whitespace = preg_replace('{\n +}', "\n", $whitespace);
                $output .= $whitespace;
            } else {
                $output .= $token[1];
            }
        }

        return $output;
    }